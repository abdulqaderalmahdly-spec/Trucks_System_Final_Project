# نظام إدارة القواطر المتكامل - نسخة Python (مُحسّنة ومؤمنة)

نسخة Python محلية من نظام إدارة القواطر المتكامل يمكن تشغيلها على الجوال أو الكمبيوتر باستخدام Termux أو Python العادي.

## المميزات المُحسّنة

- **نظام مصادقة آمن**: يتطلب تسجيل دخول للوصول إلى النظام.
- **إدارة المستخدمين**: واجهة خاصة للمسؤولين لإضافة، تعديل، وتفعيل/تعطيل المستخدمين.
- **تشفير كلمات المرور**: استخدام خوارزمية Bcrypt لتشفير كلمات المرور في قاعدة البيانات.
- **إدارة القواطر**: إضافة وتعديل وحذف القواطر وتتبع حالتها.
- **إدارة السائقين**: تسجيل السائقين وربطهم بالقواطر.
- **تحسين جدول السائقين**: عرض معلومات مفصلة عن السائقين مع إمكانية عرض كشف حساب كامل (دائن/مدين). **(تحسين جديد)**
- **كشف حساب السائق**: مسارات API جديدة لحساب الرصيد الكلي للسائق بناءً على الإيرادات والمصروفات والرواتب. **(ميزة جديدة)**
- **إدارة المصاريف المتقدمة**: صفحة مخصصة لإضافة، تعديل، وحذف وتصنيف المصاريف (رواتب، وقود، صيانة، أخرى). **(ميزة جديدة)**
- **تتبع الشحنات**: تسجيل الشحنات وتتبع حالتها.
- **الإيرادات والمصاريف**: تسجيل وتحليل الإيرادات والمصاريف.
- **التقارير والتحليلات المتقدمة**: تقارير شاملة عن الأداء والربحية وكفاءة الأسطول وتحليل المصاريف.
- **نظام الإشعارات الذكي**: تنبيهات تلقائية حول الصيانة المستحقة وانخفاض ربحية القواطر.
- **لوحة التحكم**: ملخص شامل لجميع البيانات.
- **قاعدة بيانات محلية**: SQLite لا تحتاج إلى خادم.

## هيكل المشروع المُحدّث

```
Trucks_system_Python/
├── app.py                 # التطبيق الرئيسي (تم تحديثه)
├── models.py             # نماذج قاعدة البيانات (تم إضافة نموذج User)
├── requirements.txt      # المكتبات المطلوبة (تم إضافة Flask-Login و Flask-Bcrypt)
├── auth.py               # منطق المصادقة وتسجيل الدخول والخروج
├── advanced_features.py  # منطق الميزات المتقدمة
├── advanced_routes.py    # مسارات API للميزات المتقدمة
├── driver_account.py     # منطق حساب كشف حساب السائق (جديد)
├── templates/            # صفحات HTML (تم إضافة login.html و users.html و expenses.html)
│   ├── index.html       
│   ├── dashboard.html   
│   ├── trucks.html      
│   ├── drivers.html     # تم تحديثها لعرض كشف الحساب
│   ├── shipments.html   
│   ├── reports.html     
│   ├── login.html        
│   ├── users.html        
│   ├── unauthorized.html 
│   └── expenses.html      # صفحة إدارة المصاريف (جديد)
├── static/              # الملفات الثابتة
│   ├── css/
│   │   └── style.css   
│   └── js/
│       └── app.js      
└── trucks_system.db    # قاعدة البيانات (تُنشأ تلقائياً)
```

## الإصلاحات والتحسينات

1.  **إدارة المصاريف المتقدمة**: تم إضافة صفحة `expenses.html` ومسار `/expenses` لإدارة المصاريف بشكل مركزي.
2.  **كشف حساب السائق**:
    *   تم إنشاء ملف `driver_account.py` ومنطق API لحساب رصيد السائق (دائن/مدين) بناءً على الراتب والإيرادات والمصروفات.
    *   تم تحديث صفحة `drivers.html` لعرض الرصيد الحالي للسائق وإضافة زر لعرض كشف الحساب المفصل (الشحنات والمصروفات).
3.  **تطبيق نظام المصادقة**: تم دمج `Flask-Login` و `Flask-Bcrypt` لحماية جميع مسارات API وصفحات النظام بمتطلبات تسجيل الدخول.
4.  **المستخدم الافتراضي**: عند تشغيل التطبيق لأول مرة، يتم إنشاء مستخدم مسؤول افتراضي: **`admin` / `admin123`**.
5.  **إصلاح مشكلة تسجيل المصاريف**: تم تعديل دالة `create_maintenance` في `app.py` لضمان تسجيل تكلفة الصيانة تلقائيًا كمصروف في جدول `Expense`.
6.  **تحسين معالجة التاريخ**: تم إضافة معالجة للأخطاء في دالة `update_truck` في `app.py` للتعامل مع حقل `last_maintenance_date`.

## API Endpoints المُضافة حديثاً

| الفئة | المسار | الوصف |
|---|---|---|
| **كشف حساب السائق** | `GET /api/drivers/<id>/account` | الحصول على ملخص كشف حساب السائق (الرصيد، دائن/مدين). |
| | `GET /api/drivers/<id>/account-details` | الحصول على تفاصيل كشف حساب السائق (الشحنات والمصروفات). |
| | `GET /api/drivers/accounts/summary` | الحصول على ملخص إحصائي لحسابات جميع السائقين. |

## الصفحات الرئيسية المُحدّثة

| الصفحة | الرابط | الوصف |
|--------|--------|--------|
| **تسجيل الدخول**| `http://localhost:5000/login` | صفحة تسجيل الدخول الجديدة. |
| **إدارة المصاريف**| `http://localhost:5000/expenses` | صفحة جديدة لإدارة المصاريف (رواتب، وقود، صيانة، أخرى). |
| **إدارة السائقين**| `http://localhost:5000/drivers` | تم تحديثها لعرض كشف الحساب للسائقين. |
| إدارة المستخدمين| `http://localhost:5000/users` | إضافة وإدارة المستخدمين (للمسؤولين فقط). |
| لوحة التحكم | `http://localhost:5000/dashboard` | ملخص النظام (يتطلب تسجيل دخول). |

## المتطلبات والتثبيت

### 1. استخراج الملفات
```bash
unzip Trucks_system_Python_Updated_Security.zip
cd Trucks_system_Python
```

### 2. تثبيت المكتبات المطلوبة
```bash
pip install -r requirements.txt
```

### 3. تشغيل التطبيق
```bash
python app.py
```
**ملاحظة هامة:** عند التشغيل لأول مرة، سيتم إنشاء قاعدة بيانات جديدة ومستخدم مسؤول افتراضي: **`admin` / `admin123`**.

### 4. فتح المتصفح
افتح المتصفح وادخل الرابط:
```
http://localhost:5000/login
```

---
تم إجراء هذه التحسينات والإصلاحات بواسطة **Manus AI** لضمان نظام أكثر كفاءة ودقة في إدارة أسطول القواطر.
